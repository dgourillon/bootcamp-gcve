



GCVE_NETWORK_NAME=gcve-network
GITHUB_CONNECTION_NAME=gcve-github-connection

if gcloud builds connections list --region us-central1 | grep $GITHUB_CONNECTION_NAME
then
    echo "github connection to gcve bootcamp detected"
else
    echo "github connection bot detected, exiting"
    exit 1
fi

gcloud compute networks create $GCVE_NETWORK_NAME \
    --subnet-mode=custom 


gcloud compute networks subnets create usc1-subnet \
    --network=$GCVE_NETWORK_NAME \
    --range="10.128.5.0/25" \
    --region=us-central1

gcloud compute networks subnets create usw2-subnet \
    --network=$GCVE_NETWORK_NAME \
    --range="10.128.5.128/25" \
    --region=us-west2

gcloud compute addresses create google-managed-services-$GCVE_NETWORK_NAME \
    --global \
    --purpose=VPC_PEERING \
    --addresses=192.168.0.0 \
    --prefix-length=16 \
    --description="PSA for $GCVE_NETWORK_NAME" \
    --network=$GCVE_NETWORK_NAME


   gcloud builds repositories create bootcamp-gcve \
     --remote-uri=https://github.com/dgourillon/bootcamp-gcve.git \
     --connection=$GITHUB_CONNECTION_NAME --region=us-central1 

cat > ./private_pool_config.yaml <<EOF
privatePoolV1Config:
  networkConfig:
    peeredNetwork: '$GCVE_NETWORK_NAME'
  workerConfig:
    diskSizeGb: '100'
    machineType: 'e2-medium'
EOF

gcloud builds worker-pools create gcve-pool \
--config-from-file private_pool_config.yaml \
--region us-central1

rm private_pool_config.yaml